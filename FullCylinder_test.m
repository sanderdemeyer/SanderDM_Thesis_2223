tens_one_site_l = Tensor([pspace trivspace], [trivspace pspace]);
tens = tpermute(tens_one_site_l, [2 1 4 3], [2 2]); %T_l has triv leg on the right
tblocks_up = num2cell([-1 1]);
tblocks_down = num2cell([1 -1]);
one_blocks = num2cell([1 1]);

%sigma = fill_tensor(tens, tblocks_A);
up = fill_tensor(tens, tblocks_up);
down = fill_tensor(tens, tblocks_down);
one = fill_tensor(tens, one_blocks);

M_stag = contract(up, [-17 -9 1 -1], down, [1 -10 2 -2], ...
    up, [2 -11 3 -3], down, [3 -12 4 -4], up, [4 -13 5 -5], ...
    down, [5 -14 6 -6], up, [6 -15 7 -7], down, [7 -16 -18 -8]);

AC = gs_mps.AC;
AL = gs_mps.AL;
N = 6;
%{
if N == 6
    M_stag = contract(up, [-25 -13 1 -1], down, [1 -14 2 -2], ...
    up, [2 -15 3 -3], down, [3 -16 4 -4], up, [4 -17 5 -5], ...
    down, [5 -18 6 -6], down, [6 -19 7 -7], up, [7 -20 8 -8], ...
    down, [8 -21 9 -9], up, [9 -22 10 -10], down, [10 -23 11 -11], ...
    down, [11 -24 -26 -12]);

    stag_field = contract(AL(1), [1 2 4], AL(2), [4 5 8], ...
        AL(3), [8 9 12], AL(4), [12 13 16], AL(5), [16 17 20], AL(6), [20 21 24], ...
        AL(7), [24 25 28], AC(8), [28 29 32], AC(9), [32 33 36], ...
        AC(10), [36 37 40], AC(11), [40 41 44], AC(12), [44 45 48], ...
        conj(AL(1)), [1 3 6], conj(AL(2)), [6 7 10], conj(AL(3)), [10 11 14], ...
        conj(AL(4)), [14 15 18], conj(AL(5)), [18 19 22], conj(AL(6)), [22 23 26], ...
        conj(AL(7)), [26 27 30], conj(AL(8)), [30 31 34], conj(AL(9)), [34 35 38], ...
        conj(AL(10)), [38 39 42], conj(AL(11)), [42 43 46], conj(twist(AC(12),3)), [46 47 48], ...
        M_stag, [2 5 9 13 17 21 25 29 33 37 41 45 3 7 11 15 19 23 27 31 35 39 43 47 -1 -2]);
elseif N == 4
    M_stag = contract(up, [-17 -9 1 -1], down, [1 -10 2 -2], ...
    up, [2 -11 3 -3], down, [3 -12 4 -4], down, [4 -13 5 -5], ...
    up, [5 -14 6 -6], down, [6 -15 7 -7], up, [7 -16 -18 -8]);

    stag_field = contract(AL(1), [1 2 4], AL(2), [4 5 8], ...
        AL(3), [8 9 12], AL(4), [12 13 16], AL(5), [16 17 20], AL(6), [20 21 24], ...
        AL(7), [24 25 28], AC(8), [28 29 32], conj(AL(1)), [1 3 6], ...
        conj(AL(2)), [6 7 10], conj(AL(3)), [10 11 14], conj(AL(4)), [14 15 18], ...
        conj(AL(5)), [18 19 22], conj(AL(6)), [22 23 26], conj(AL(7)), [26 27 30], ...
        conj(twist(AC(8),3)), [30 31 32], M_stag, [2 5 9 13 17 21 25 29 3 7 11 15 19 23 27 31 -1 -2]);
elseif N == 2
    M_stag = contract(up, [-9 -5 1 -1], down, [1 -6 2 -2], ...
    down, [2 -7 3 -3], up, [3 -8 -10 -4]);

    stag_field = contract(AL(1), [1 2 4], AL(2), [4 5 8], ...
        AL(3), [8 9 12], AL(4), [12 13 16], conj(AL(1)), [1 3 6], ...
        conj(AL(2)), [6 7 10], conj(AL(3)), [10 11 14], conj(twist(AL(4),3)), [14 15 16], ...
        M_stag, [2 5 9 13 3 7 11 15 -1 -2]);
end
%}

x = contract(AL(1), [1 2 -1], up, [-4 3 -2 2], conj(AL(1)), [1 3 -3]);
for i = 2:2*N-1
    disp(i);
    if ((mod(i,2) == 0) - 1/2)*((i > N) - 1/2) == 1/4
    x = contract(x, [1 3 5 -4], AL(i), [1 2 -1], up, [3 4 -2 2], conj(AL(i)), [5 4 -3]);
    else
    x = contract(x, [1 3 5 -4], AL(i), [1 2 -1], down, [3 4 -2 2], conj(AL(i)), [5 4 -3]);
    end
end
stag_field = contract(x, [1 3 5 -1], AC(2*N), [1 2 6], up, [3 4 -2 2], conj(twist(AC(2*N),3)), [5 4 6]);


stag_field = stag_field.var.var;
disp(stag_field);
